{% extends "base.html" %}

{% block title %}{{ recipe.name }} - –ö–Ω–∏–≥–∞ —Ä–µ—Ü–µ–ø—Ç–æ–≤{% endblock %}

{% block content %}
<a href="/" class="back-btn">‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É —Ä–µ—Ü–µ–ø—Ç–æ–≤</a>

<div class="card">
    <h1>{{ recipe.name }}</h1>

    <div class="servings-input">
        <label for="servings">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–µ—Ä—Å–æ–Ω:</label>
        <input type="number" id="servings" min="1" max="20" value="{{ recipe.servings }}" />
        <button onclick="updateServings('{{ recipe.id }}')">–ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å</button>
        <p style="margin-top: 10px; color: #666;">
            –ë–∞–∑–æ–≤—ã–π —Ä–µ—Ü–µ–ø—Ç —Ä–∞—Å—Å—á–∏—Ç–∞–Ω –Ω–∞ {{ recipe.base_servings }} –ø–µ—Ä—Å–æ–Ω{{ '—É' if recipe.base_servings == 1 else ('—ã' if recipe.base_servings < 5 else '') }}
        </p>
    </div>
</div>

<div class="recipe-content">
    <div class="left-column">
        <!-- –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã -->
        <div class="section">
            <h3>ü•ò –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã (–Ω–∞ {{ recipe.servings }} –ø–µ—Ä—Å–æ–Ω{{ '—É' if recipe.servings == 1 else ('—ã' if recipe.servings < 5 else '') }})</h3>
            <table class="ingredients-table">
                <thead>
                    <tr>
                        <th>–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç</th>
                        <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                        <th>–ï–¥–∏–Ω–∏—Ü–∞</th>
                    </tr>
                </thead>
                <tbody>
                    {% for ingredient in recipe.ingredients %}
                    <tr>
                        <td>{{ ingredient.name }}</td>
                        <td class="quantity-highlight">
                            {% if ingredient.quantity == ingredient.quantity|int %}
                                {{ ingredient.quantity|int }}
                            {% else %}
                                {{ "%.1f"|format(ingredient.quantity) }}
                            {% endif %}
                        </td>
                        <td>{{ ingredient.unit }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- –°–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫ -->
        <div class="section">
            <h3>üõí –°–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫</h3>
            <table class="shopping-table" id="shopping-list">
                <thead>
                    <tr>
                        <th>–ü—Ä–æ–¥—É–∫—Ç</th>
                        <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                        <th>–ï–¥–∏–Ω–∏—Ü–∞</th>
                    </tr>
                </thead>
                <tbody id="shopping-tbody">
                    <!-- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <div class="right-column">
        <!-- –®–∞–≥–∏ –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è -->
        <div class="section">
            <h3>üë®‚Äçüç≥ –®–∞–≥–∏ –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è</h3>
            <table class="steps-table">
                <thead>
                    <tr>
                        <th style="width: 80px;">–®–∞–≥</th>
                        <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                    </tr>
                </thead>
                <tbody>
                    {% for step in recipe.steps %}
                    <tr>
                        <td style="text-align: center;">
                            <span class="step-number">{{ loop.index }}</span>
                        </td>
                        <td>{{ step }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
// –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    const recipeIngredients = JSON.parse('{{ recipe.ingredients | tojson }}');
    generateShoppingListTable(ingredients);
});

function generateShoppingListTable(recipeIngredients) {
    // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏ –µ–¥–∏–Ω–∏—Ü–µ –∏–∑–º–µ—Ä–µ–Ω–∏—è
    const grouped = {};
    recipeIngredients.forEach(ingredient => {
        const key = `${ingredient.name}_${ingredient.unit}`;
        if (grouped[key]) {
            grouped[key].quantity += ingredient.quantity;
        } else {
            grouped[key] = {
                name: ingredient.name,
                unit: ingredient.unit,
                quantity: ingredient.quantity
            };
        }
    });

    const shoppingList = Object.values(grouped);
    const tbody = document.getElementById('shopping-tbody');
    tbody.innerHTML = '';

    shoppingList.forEach(item => {
        const row = document.createElement('tr');

        // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
        let quantity = item.quantity;
        if (quantity === Math.floor(quantity)) {
            quantity = Math.floor(quantity);
        } else {
            quantity = quantity.toFixed(1);
        }

        row.innerHTML = `
            <td>${item.name}</td>
            <td class="quantity-highlight">${quantity}</td>
            <td>${item.unit}</td>
        `;

        tbody.appendChild(row);
    });
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ Enter –≤ –ø–æ–ª–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–µ—Ä—Å–æ–Ω
document.getElementById('servings').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        updateServings('{{ recipe.id|escapejs }}');
    }
});
</script>
{% endblock %}
